<% layout('/layouts/boilerplate') %>
<% title = `Profile | VH Event Manager`; %>

  <div class="container py-4">
    <div class="row">
      <h1 class="mb-3 pl-5">Profile</h1>



      <% if (managementProfile && managementProfile.powerhouse) { %>
        <div class="d-flex justify-content-space-between align-items-center pl-4 rounded-3">
          <p class="ml-4 bg-lighta"> <%= managementProfile.fullName %>
          </p>
          
          <p class="ml-4 bg-lighta"> <%= currentUser.email %>
          </p>
            
        </div>
         <p class="pl-5">ðŸ‘‘ Powerhouse Member</p>
        <style>
          .bg-lighta{
            background-color: #ffbf67;
            padding: 10px;
            border-radius: 8px;
            color: white;
          }
        </style>


     
        <% } %>

          <% if (currentUser.isAdmin) { %>
            <form class="p-to-admin" action="/admin" method="GET" class="mb-3">
              <button type="submit" class="btn btn-primary">Go to Admin Dashboard</button>
            </form>
            <br><br>
            <% } %>

              <!-- ===================== ASSIGNED EVENTS ===================== -->
              <% if (assignedEvents && assignedEvents.length> 0) { %>
                <h4 class="mt-5">Assigned Events - <i>
                    <%= new Date().toDateString() %>
                  </i></h4>
                <div class="row">
                  <% assignedEvents.forEach(event=> { %>
                    <div class="col-md-6 mb-4">
                      <div class="card border-0 shadow-sm p-3" style="background: #d8deff; border-radius: 12px;">
                        <h5 class="fw-bold text-primary mb-2">
                          <i class="bi bi-calendar-event me-1"></i>
                          <%= event.name %>
                        </h5>

                        <p class="mb-1"><i class="bi bi-geo-alt me-1"></i> <strong>Location:</strong>
                          <%= event.location %>
                        </p>
                        <p class="mb-1"><i class="bi bi-calendar-date me-1"></i> <strong>Date:</strong>
                          <%= new Date(event.date).toDateString() %>
                        </p>
                        <p class="mb-1"><i class="bi bi-people me-1"></i> <strong>Total Volunteers:</strong>
                          <%= event.totalVolunteers %>
                        </p>
                        <p class="mb-1"><i class="bi bi-person-fill me-1"></i>
                          <strong>Male:</strong>
                          <%= event.maleReq %> |
                            <strong>Female:</strong>
                            <%= event.femaleReq %>
                        </p>

                        <p class="mb-2"><strong>Status:</strong>
                          <span class="badge 
                  <%= event.status === 'Completed' ? 'bg-success' :
                      event.status === 'Ongoing' ? 'bg-warning text-dark' :
                      'bg-secondary' %>">
                            <%= event.status %>
                          </span>
                        </p>

                        <p class="mb-1">
                          <strong>Description:</strong>
                          <span class="description-text" id="desc-<%= event._id %>">
                            <%= event.description || 'N/A' %>
                          </span>
                          <% if (event.description && event.description.length> 100) { %>
                            <a href="javascript:void(0);" class="read-more text-primary ms-1"
                              onclick="toggleDescription('<%= event._id %>')">Read more</a>
                            <% } %>
                        </p>

                        
                        <p class="fw-bold mb-1">Your Assigned Departments:</p>
                        <% const yourDepartments=event.departmentAssignments .filter(dep=>
                          dep.assignedVolunteers.some(vol => vol.equals(managementProfile?._id)))
                          .map(dep => dep.department);
                          %>
                          <% if (yourDepartments.length> 0) { %>
                            <% yourDepartments.forEach(dep=> { %>
                              <span class="badge bg-info text-dark me-1 mb-1">
                                <%= dep %>
                              </span>
                              <% }) %>
                                <% } else { %>
                                  <span class="text-muted">Not assigned in any department</span>
                                  <% } %>

                                    <br>
                                    <small class="text-muted">Created at: <%= event.createdAt.toDateString() %></small>
                      </div>
                    </div>
                    <% }) %>
                </div>
                <% } else { %>
                  <div class="alert alert-info mt-4">No events assigned yet.</div>
                  <% } %>

                    <!-- ===================== MANAGEMENT PROFILE ===================== -->
                    <% if (managementProfile) { %>
                      <h4 class="mt-5">Management Profile</h4>
                      <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
                        rel="stylesheet">

                      <div class="card shadow-lg my-4 mx-auto"
                        style="max-width: 480px; background: #f4f7ff; color: #333; border-radius: 16px;">
                        <div class="profile-m-img">
                          <img src="<%= managementProfile.profilePicture %>" alt="Profile Picture"
                            crossorigin="anonymous">
                        </div>

                        <div class="card-body p-4 watermarked-container">
                          <div class="watermark-text top-left">MADE BY VH-EVENTS</div>
                          <div class="watermark-text center">MADE BY VH-EVENTS</div>
                          <div class="watermark-text bottom-right">MADE BY VH-EVENTS</div>

                          <h5 class="card-title text-primary fw-bold mb-2">
                            <i class="bi bi-person-circle me-1"></i>
                            <%= managementProfile.fullName %>
                              <small class="text-muted">(<%= managementProfile.age %> yrs)</small>
                          </h5>

                          <p class="text-muted mb-3"><i class="bi bi-telephone me-1"></i>
                            <%= managementProfile.mobileNumber %> | <%= managementProfile.gender %>
                          </p>

                          <p class="text-muted mb-3"><i class="bi bi-envelope me-1"></i>
                            <%= managementProfile.email %>
                          </p>

                          <hr>
                          <p><strong>ID:</strong>
                            <%= managementProfile._id %>
                          </p>
                          <p><strong>Height:</strong>
                            <%= managementProfile.height || 'N/A' %>
                          </p>
                          <p><strong>Current City:</strong>
                            <%= managementProfile.currentCity || 'N/A' %>
                          </p>

                          <p><strong>Other Cities:</strong>
                            <% if (managementProfile.otherCities?.length) { %>
                              <%= managementProfile.otherCities.join(', ') %>
            <% } else { %> N/A <% } %>
          </p>

          <p><strong>Languages:</strong><br>
            <% if (managementProfile.languages?.length) { %>
              <% managementProfile.languages.forEach(lang => { %>
                <span class="badge bg-secondary me-1 mb-1"><%= lang %></span>
              <% }) %>
            <% } %>
            <% if (managementProfile.otherLanguage) { %>
              <span class="badge bg-secondary me-1 mb-1"><%= managementProfile.otherLanguage %></span>
            <% } else if (!managementProfile.languages?.length) { %> N/A <% } %>
          </p>

          <p><strong>Experience:</strong> <%= managementProfile.experienceYears || 0 %> yrs</p>
          <p><strong>Events Worked:</strong> <%= managementProfile.eventsWorked || ' N/A' %>
                          </p>

                          <p><strong>Event Categories:</strong><br>
                            <% if (managementProfile.eventCategories?.length) { %>
                              <% managementProfile.eventCategories.forEach(cat=> { %>
                                <span class="badge bg-info text-dark me-1 mb-1">
                                  <%= cat %>
                                </span>
                                <% }) %>
                                  <% } else { %> N/A <% } %>
                          </p>

                          <p><strong>Companies/Brands:</strong>
                            <%= managementProfile.companiesWorkedWith || 'N/A' %>
                          </p>

                          <p><strong>Departments:</strong><br>
                            <% if (managementProfile.departmentsWorked?.length) { %>
                              <% managementProfile.departmentsWorked.forEach(dep=> { %>
                                <span class="badge bg-warning text-dark me-1 mb-1">
                                  <%= dep %>
                                </span>
                                <% }) %>
                                  <% } else { %> N/A <% } %>
                          </p>

                          <p><strong>Best Department:</strong>
                            <%= managementProfile.bestDepartment || 'N/A' %>
                          </p>

                          <p><strong>Skills:</strong><br>
                            <% if (managementProfile.skills?.length) { %>
                              <% managementProfile.skills.forEach(skill=> { %>
                                <span class="badge bg-success me-1 mb-1">
                                  <%= skill %>
                                </span>
                                <% }) %>
                                  <% } else { %> N/A <% } %>
                          </p>

                          <p><strong>Working Style:</strong> <em class="text-muted">
                              <%= managementProfile.workingStyle || 'N/A' %>
                            </em></p>

                          <% if (managementProfile.instagram) { %>
                            <p><strong>Instagram:</strong>
                              <a href="<%= managementProfile.instagram %>" class="text-decoration-none text-primary"
                                target="_blank">
                                <i class="bi bi-instagram"></i> Visit Profile
                              </a>
                            </p>
                            <% } %>

                              <a href="/management/<%= managementProfile._id %>/edit"
                                class="btn btn-outline-primary w-100 mt-2">
                                <i class="bi bi-pencil-square"></i> Edit Profile
                              </a>

                              <form action="/management/<%= managementProfile._id %>?_method=DELETE" method="POST"
                                class="mt-3"
                                onsubmit="return confirm('Are you sure you want to delete this profile?');">
                                <button type="submit" class="btn btn-outline-danger w-100">
                                  <i class="bi bi-trash3"></i> Delete Profile
                                </button>
                              </form>
                              <br><br>
                        </div>
                      </div>
                      <% } else { %>
                        <div class="alert alert-warning mt-4">
                          No management profile found.
                          <a href="/management" class="btn btn-success btn-sm ms-2">Be a Management Member</a>
                        </div>
                        <% } %>

                          <!-- ===================== BOOKINGS ===================== -->
                          <h4 class="mt-5">Your Bookings</h4>
                          <% if (!bookings || bookings.length===0) { %>
                            <p>No bookings yet.</p>
                            <% } else { %>
                              <ul class="list-unstyled">
                                <% bookings.forEach(booking=> { %>
                                  <li class="mb-4 list-group-item shadow-sm border-0 rounded-3 p-4"
                                    style="background: #f8faff;">
                                    <h5 class="fw-bold mb-3 text-primary">
                                      <i class="bi bi-receipt-cutoff me-1"></i> Booking ID: <%= booking._id %>
                                    </h5>

                                    <div class="row g-2">
                                      <div class="col-6"><i class="bi bi-calendar-event me-1"></i><strong> Event
                                          Type:</strong>
                                        <%= booking.eventType %>
                                      </div>
                                      <div class="col-6"><i class="bi bi-building me-1"></i><strong> Venue
                                          Type:</strong>
                                        <%= booking.venueType %>
                                      </div>
                                      <div class="col-12"><i class="bi bi-geo-alt me-1"></i><strong> Venue
                                          Location:</strong>
                                        <%= booking.venueLocation %>
                                      </div>
                                      <div class="col-6"><i class="bi bi-clock me-1"></i><strong> Consultation
                                          Date:</strong>
                                        <%= booking.consultationDate ? booking.consultationDate.toDateString()
                                          : "No date" %>
                                      </div>
                                      <div class="col-6"><i class="bi bi-calendar-check me-1"></i><strong> Booked
                                          At:</strong>
                                        <%= booking.createdAt ? booking.createdAt.toDateString() : "N/A" %>
                                      </div>
                                    </div>

                                    <hr class="my-3">

                                    <div class="row g-2">
                                      <div class="col-md-6"><i class="bi bi-person me-1"></i><strong> Name:</strong>
                                        <%= booking.fullName %>
                                      </div>
                                      <div class="col-md-6"><i class="bi bi-envelope me-1"></i><strong> Email:</strong>
                                        <%= booking.email %>
                                      </div>
                                      <div class="col-md-6"><i class="bi bi-phone me-1"></i><strong> Phone:</strong>
                                        <%= booking.phone %>
                                      </div>
                                      <div class="col-md-6"><i class="bi bi-geo me-1"></i><strong> City:</strong>
                                        <%= booking.city || "N/A" %>
                                      </div>
                                      <div class="col-md-12"><i class="bi bi-ui-checks me-1"></i><strong> Special
                                          Requirements:</strong>
                                        <%= booking.requirements || "None" %>
                                      </div>
                                      <div class="col-md-12"><i class="bi bi-megaphone me-1"></i><strong> Heard
                                          From:</strong>
                                        <%= booking.heardFrom || "N/A" %>
                                      </div>
                                      <div class="col-md-12"><i class="bi bi-chat-left-text me-1"></i><strong> Admin
                                          Notes:</strong>
                                        <%= booking.adminNote || "N/A" %>
                                      </div>
                                    </div>

                                    <form action="/booking/<%= booking._id %>?_method=DELETE" method="POST" class="mt-4"
                                      onsubmit="return confirmCancel();">
                                      <button type="submit" class="btn btn-outline-danger w-100">
                                        <i class="bi bi-x-circle"></i> Cancel Booking
                                      </button>
                                    </form>
                                  </li>
                                  <% }) %>
                              </ul>
                              <% } %>
    </div>
  </div>

  <!-- ===================== SCRIPTS & STYLES ===================== -->
  <script>
    function confirmCancel() {
      return confirm("Are you sure you want to cancel this booking?");
    }

    function toggleDescription(id) {
      const desc = document.getElementById('desc-' + id);
      const link = event.target;
      if (desc.classList.contains('expanded')) {
        desc.classList.remove('expanded');
        link.innerText = 'Read more';
      } else {
        desc.classList.add('expanded');
        link.innerText = 'Read less';
      }
    }
  </script>

  <style>
    .description-text {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: all 0.3s ease-in-out;
    }

    .description-text.expanded {
      -webkit-line-clamp: unset;
      overflow: visible;
    }

    .profile-m-img {
      width: 100%;
      height: 400px;
      overflow: hidden;
      border-radius: 20px 20px 0 0;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      margin: 20px 0 0;
    }

    .profile-m-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center 30%;
    }

    .watermark-text {
      position: absolute;
      font-size: 36px;
      font-weight: bold;
      color: #5f5f5f;
      opacity: 0.2;
      pointer-events: none;
      user-select: none;
      white-space: nowrap;
      z-index: 0;
      transform: rotate(-30deg);
    }

    .top-left {
      top: 15%;
      left: 20px;
    }

    .center {
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
    }

    .bottom-right {
      bottom: 20%;
      right: 20px;
    }

 .p-to-admin{
    width: 300px;
    margin: 0px 0px 0px 40px;
 }   
  </style>